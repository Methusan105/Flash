<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  
  <style>
    /* Set the dimensions of the video container */
    .plyr-container {
      width: 500px; /* Set the width you need */
      height: 264px; /* Set the height you need */
    }

    /* Ensure the video element takes up the full size of the container */
    .plyr__video-embed iframe,
    .plyr__video-embed video {
      width: 100%;
      height: 100%;
    }
  </style>
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
</head>
<body>
<div class="plyr-container">
  <video
    id="my-video"
    class="plyr"
    controls
    preload="auto"
    width="640"
    height="264"
    poster="MY_VIDEO_POSTER.jpg"
    data-setup='{ "customControlsOnMobile": true, "nativeControlsForTouch": false }'
  >
    <source src="https://github.com/Methusan105/Series/releases/download/TF7/The.Flash.S07E17.mp4" type="video/mp4" />
    <track kind="subtitles" src="https://raw.githubusercontent.com/Methusan105/Series/main/Flash/S07/Subs/The.Flash.S07E17.vtt" srclang="en" label="English" default>
    <p class="vjs-no-js">
      To view this video please enable JavaScript, and consider upgrading to a
      web browser that
      <a href="https://videojs.com/html5-video-support/" target="_blank"
        >supports HTML5 video</a
      >
    </p>
  </video>
</div>
<script>
    // Initialize Plyr
    var video = document.getElementById('my-video');
    const player = new Plyr('#my-video');

    let spacePressed = false;
    let isVideoPaused = false;

    document.addEventListener('DOMContentLoaded', function () {
      document.addEventListener('keydown', function (event) {
        if (event.key === " ") {
          event.preventDefault(); // Prevent default spacebar behavior (scrolling down)
          togglePause();
        }
        if (event.key === "f") {
          fullscr();
        }
        if (event.key === "ArrowLeft") { // Seek backward when left arrow key is pressed
          seekBackward();
        }
        if (event.key === "ArrowRight") { // Seek forward when right arrow key is pressed
          seekForward();
        }
      });

      function togglePause() {
        if (player.paused) {
          player.play();
        } else {
          player.pause();
        }
      }

      function fullscr() {
        if (player.fullscreen.active) {
          player.fullscreen.exit();
        } else {
          player.fullscreen.enter();
        }
      }

      function seekForward() {
        player.currentTime = player.currentTime + 5; // Seek 5 seconds forward
      }

      function seekBackward() {
        player.currentTime = player.currentTime - 5; // Seek 5 seconds backward
      }

      var gistFilename = 'video_progress.json';

      // Retrieve user credentials from sessionStorage
      var username = sessionStorage.getItem('githubUsername');
      var gistId = sessionStorage.getItem('githubGistId');
      var accessToken = sessionStorage.getItem('githubAccessToken');

      if (!username || !gistId || !accessToken) {
        var isTV = detectTV();
        if (isTV) {
          username = prompt('Enter your GitHub username:');
          gistId = prompt('Enter your Gist ID:');
          accessToken = prompt('Enter your GitHub Personal Access Token:');
          sessionStorage.setItem('githubUsername', username);
          sessionStorage.setItem('githubGistId', gistId);
          sessionStorage.setItem('githubAccessToken', accessToken);
          setupVideoPlayback();
        }
        if (!document.getElementById('fileInput')) {
          var fileInput = createFileInput();
          document.body.appendChild(fileInput);
        }
      } else {
        setupVideoPlayback();
      }

      function detectTV() {
        var userAgent = navigator.userAgent.toLowerCase();
        return userAgent.includes('tv');
      }

      function createFileInput() {
        var input = document.createElement('input');
        input.id = 'fileInput';
        input.type = 'file';
        input.accept = '.txt';
        input.addEventListener('change', function(event) {
          var file = event.target.files[0];
          if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
              processFileContent(e.target.result);
            };
            reader.readAsText(file);
          }
        });
        return input;
      }

      function processFileContent(content) {
        var lines = content.split('\n');
        lines.forEach(function(line) {
          var parts = line.split('=');
          if (parts.length === 2) {
            var key = parts[0].trim().toLowerCase();
            var value = parts[1].trim();
            if (key === 'username') {
              username = value;
            } else if (key === 'gist id') {
              gistId = value;
            } else if (key === 'token') {
              accessToken = value;
            }
          }
        });

        sessionStorage.setItem('githubUsername', username);
        sessionStorage.setItem('githubGistId', gistId);
        sessionStorage.setItem('githubAccessToken', accessToken);

        setupVideoPlayback();
      }

      function setupVideoPlayback() {
        var gistScript = document.createElement('script');
        gistScript.src = `https://gist.github.com/${username}/${gistId}.js?access_token=${accessToken}`;
        document.head.appendChild(gistScript);

        function handleNetworkError() {
          console.log('A network error has occurred. Refreshing video...')
          video.load();

          fetch(`https://api.github.com/gists/${gistId}`)
            .then(response => response.json())
            .then(data => {
              if (data.files[gistFilename]) {
                var progressData = JSON.parse(data.files[gistFilename].content);
                if (progressData.progress) {
                  player.currentTime = parseFloat(progressData.progress);
                }
              }
            });
        }

        player.on('error', function () {
          if (player.error && player.error.code === 2) {
            var progressData = {
              "progress": player.currentTime,
              "url": window.location.href
            };
            var gistData = {
              "files": {
                [gistFilename]: {
                  "content": JSON.stringify(progressData, null, 2)
                }
              }
            };
            fetch(`https://api.github.com/gists/${gistId}`, {
              method: 'PATCH',
              headers: {
                'Authorization': 'token ' + `${accessToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(gistData)
            })
              .then(response => response.json())
              .then(data => {
                console.log('Progress saved to Gist:', data);
                setTimeout(function () {
                  handleNetworkError();
                  player.play();
                }, 3000);
              });
          }
        });

        player.on('timeupdate', function () {
          if (player.paused && !isVideoPaused) {
            isVideoPaused = true;
            var progressData = {
              "progress": player.currentTime,
              "url": window.location.href
            };
            var gistData = {
              "files": {
                [gistFilename]: {
                  "content": JSON.stringify(progressData, null, 2)
                }
              }
            };
            fetch(`https://api.github.com/gists/${gistId}`, {
              method: 'PATCH',
              headers: {
                'Authorization': 'token ' + `${accessToken}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(gistData)
            })
              .then(response => response.json())
              .then(data => console.log('Progress saved to Gist:', data));
          }
        });

        player.on('play', function () {
          isVideoPaused = false;
        });

        fetch(`https://api.github.com/gists/${gistId}`)
          .then(response => response.json())
          .then(data => {
            if (data.files[gistFilename]) {
              var progressData = JSON.parse(data.files[gistFilename].content);
              if (progressData.progress) {
                player.currentTime = parseFloat(progressData.progress);
              }
            }
          });

        window.addEventListener('beforeunload', function () {
          sessionStorage.removeItem('githubUsername');
          sessionStorage.removeItem('githubGistId');
          sessionStorage.removeItem('githubAccessToken');
        });
      }
    });
  </script>




<script src="/Series/Playback.js"></script>
  <br><br>
  
  <a onclick="clearGistProgress()">Click me! if you have watched the episode finished</a>
  <br><br>
    <a onclick="clearGistProgress()" href="/Series/Flash/S07/18.html">Next Episode</a>
</body>
</html>
