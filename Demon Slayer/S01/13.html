<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />

  <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
  <!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
</head>
<body>
  <video
    id="my-video"
    class="video-js"
    controls
    preload="auto"
    width="640"
    height="264"
    poster="MY_VIDEO_POSTER.jpg"
    data-setup="{}"
  >
  <source src="https://github.com/Methusan105/Series/releases/download/DS1/Demon.Slayer.S01E13.mp4" type="video/mp4" />
    <p class="vjs-no-js">
      To view this video please enable JavaScript, and consider upgrading to a
      web browser that
      <a href="https://videojs.com/html5-video-support/" target="_blank"
        >supports HTML5 video</a
      >
    </p>
  </video>
<script>
    var video = document.getElementById('my-video');
    document.addEventListener('DOMContentLoaded', function () {
      var gistFilename = 'video_progress.json';
      var isVideoPaused = false; // Track video pause/resume status

      // Retrieve user credentials from sessionStorage
      var username = sessionStorage.getItem('githubUsername');
      var gistId = sessionStorage.getItem('githubGistId');
      var accessToken = sessionStorage.getItem('githubAccessToken');

      // If user credentials are not in sessionStorage, prompt for them
      if (!username || !gistId || !accessToken) {
        username = prompt('Enter your GitHub username:');
        gistId = prompt('Enter your Gist ID:');
        accessToken = prompt('Enter your GitHub Personal Access Token:');

        // Save user credentials to sessionStorage
        sessionStorage.setItem('githubUsername', username);
        sessionStorage.setItem('githubGistId', gistId);
        sessionStorage.setItem('githubAccessToken', accessToken);
      }

      // Use the provided values for GitHub username, Gist ID, and token
      var gistScript = document.createElement('script');
      gistScript.src = `https://gist.github.com/${username}/${gistId}.js?access_token=${accessToken}`;
      document.head.appendChild(gistScript);

      // Function to handle the network error
      function handleNetworkError() {
      console.log('A network error has occurred. Refreshing video...')

          // Now load the video after saving the progress
          video.load();

          // Retrieve progress data from Gist and set currentTime
          fetch(`https://api.github.com/gists/${gistId}`)
            .then(response => response.json())
            .then(data => {
              if (data.files[gistFilename]) {
                var progressData = JSON.parse(data.files[gistFilename].content);
                if (progressData.progress) {
                  video.currentTime = parseFloat(progressData.progress);
                }
              }
            });
        }

      // Add an error event listener to the video element
     video.addEventListener('error', function () {
  if (video.error && video.error.code === 2) {
    // Save the progress to the Gist when a network error occurs
    var progressData = {
      "progress": video.currentTime,
      "url": window.location.href // Add the URL here
    };
    var gistData = {
      "files": {
        [gistFilename]: {
          "content": JSON.stringify(progressData, null, 2)
        }
      }
    };
    fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': 'token ' + `${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(gistData)
    })
      .then(response => response.json())
      .then(data => {
        console.log('Progress saved to Gist:', data);

        // Introduce a 3-second timeout before calling handleNetworkError() and playing the video
        setTimeout(function () {
          handleNetworkError();
          video.play();
        }, 3000);
      });
  }
});


      // Handle saving and loading video playback progress
      video.addEventListener('timeupdate', function () {
        // Check if the video is paused
        if (video.paused && !isVideoPaused) {
          isVideoPaused = true;
          // Save the progress to the Gist when paused
          var progressData = {
            "progress": video.currentTime,
            "url": window.location.href // Add the URL here
          };
          var gistData = {
            "files": {
              [gistFilename]: {
                "content": JSON.stringify(progressData, null, 2)
              }
            }
          };
          fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'PATCH',
            headers: {
              'Authorization': 'token ' + `${accessToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(gistData)
          })
            .then(response => response.json())
            .then(data => console.log('Progress saved to Gist:', data));
        }
      });

      video.addEventListener('play', function () {
        // Video resumed playing, mark it as not paused
        isVideoPaused = false;
      });

      // Retrieve progress data from the Gist when the page loads
      fetch(`https://api.github.com/gists/${gistId}`)
        .then(response => response.json())
        .then(data => {
          if (data.files[gistFilename]) {
            var progressData = JSON.parse(data.files[gistFilename].content);
            if (progressData.progress) {
              video.currentTime = parseFloat(progressData.progress);
            }
          }
        });

      // Clear user credentials from sessionStorage when the tab is closed
      window.addEventListener('beforeunload', function () {
        sessionStorage.removeItem('githubUsername');
        sessionStorage.removeItem('githubGistId');
        sessionStorage.removeItem('githubAccessToken');
      });
    });
</script>
  <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
<script src="/Series/Playback.js"></script>

</body>
<body>
    <br>
    <br>
    <a onclick="clearGistProgress()" href="/Series/Demon%20Slayer/S01/14.html">Next Episode</a>
</body>
</html>
